{% extends "base.html" %}

{% block header_title %}Источники{% endblock %}

{% block content %}
{% if not projects %}
<div class="empty-state">
    <i>folder_off</i>
    <h5 style="margin-top: 16px;">Нет проектов</h5>
    <p class="secondary-text">Сначала создайте проект</p>
    <button class="large round" onclick="location.href='{{ url_for('projects_list') }}?action=new'" style="margin-top: 24px;">
        <i>folder</i>
        <span>Создать проект</span>
    </button>
</div>
{% else %}

<!-- Project Filter -->
<div class="card" style="margin-bottom: 16px;">
    <div style="padding: 12px 16px;">
        <div class="field suffix border round" style="margin: 0;">
            <select id="project-filter" onchange="filterByProject(this.value)">
                <option value="">Все проекты</option>
                {% for project in projects %}
                <option value="{{ project.id }}" {% if selected_project == project.id|string %}selected{% endif %}>
                    {{ project.name }}
                </option>
                {% endfor %}
            </select>
            <i>arrow_drop_down</i>
        </div>
    </div>
</div>

{% if not sources %}
<div class="empty-state">
    <i>cloud_off</i>
    <h5 style="margin-top: 16px;">Нет источников</h5>
    <p class="secondary-text">Добавьте первый источник данных</p>
</div>
{% else %}
<div class="card">
    {% for source in sources %}
    <div class="list-tile" id="source-{{ source.id }}">
        <div class="leading" style="background: {% if source.is_active %}var(--primary){% else %}var(--outline){% endif %};">
            <i style="color: white;">{% if source.source_type == 'jira' %}bug_report{% elif source.source_type == 'slack' %}tag{% elif source.source_type == 'gmail' %}mail{% elif source.source_type == 'google_calendar' %}calendar_month{% elif source.source_type == 'outlook_mail' %}mail{% elif source.source_type == 'outlook_calendar' %}calendar_month{% elif source.source_type == 'teams' %}groups{% else %}cloud{% endif %}</i>
        </div>
        <div class="content">
            <p class="title">{{ source.name }}</p>
            <p class="subtitle">{{ source.source_type | replace('_', ' ') | title }} · {{ source.project_name }}</p>
        </div>
        <button class="circle transparent small" onclick="showSourceMenu('{{ source.id }}', '{{ source.name }}', {{ source.is_active | lower }})">
            <i>more_vert</i>
        </button>
    </div>
    {% if not loop.last %}<div class="divider" style="margin-left: 72px;"></div>{% endif %}
    {% endfor %}
</div>
{% endif %}

<!-- FAB -->
<button class="fab primary" onclick="document.getElementById('new-source-dialog').showModal()">
    <i>add</i>
</button>

<!-- New Source Dialog -->
<dialog id="new-source-dialog" class="round" style="max-width: 360px; width: calc(100% - 32px);">
    <h5>Новый источник</h5>
    <form hx-post="/api/sources"
          hx-swap="none"
          hx-on::after-request="if(event.detail.successful) { this.reset(); this.closest('dialog').close(); location.reload(); }">

        <div class="field label suffix border round">
            <select name="project_id" id="new-source-project" required>
                <option value="">Выберите проект</option>
                {% for project in projects %}
                <option value="{{ project.id }}" {% if selected_project == project.id|string %}selected{% endif %}>{{ project.name }}</option>
                {% endfor %}
            </select>
            <label>Проект</label>
            <i>arrow_drop_down</i>
        </div>

        <div class="field label suffix border round">
            <select name="source_type" required onchange="showCredentialsFields(this.value)">
                <option value="">Выберите тип</option>
                <option value="jira">Jira</option>
                <option value="slack">Slack</option>
                <option value="gmail">Gmail</option>
                <option value="google_calendar">Google Calendar</option>
                <option value="outlook_mail">Outlook Mail</option>
                <option value="outlook_calendar">Outlook Calendar</option>
                <option value="teams">Microsoft Teams</option>
            </select>
            <label>Тип источника</label>
            <i>arrow_drop_down</i>
        </div>

        <div class="field label border round">
            <input type="text" name="name" required minlength="1" maxlength="100">
            <label>Название</label>
        </div>

        <div id="credentials-fields"></div>

        <nav class="right-align" style="margin-top: 16px;">
            <button type="button" class="border round" onclick="this.closest('dialog').close()">Отмена</button>
            <button type="submit" class="round">Добавить</button>
        </nav>
    </form>
</dialog>

<!-- Source Actions Bottom Sheet -->
<dialog id="source-actions-dialog" class="round" style="max-width: 360px; width: calc(100% - 32px);">
    <h6 id="source-actions-title" style="margin-bottom: 16px;"></h6>
    <div class="list-tile" onclick="testCurrentSource()">
        <i>verified</i>
        <div class="content"><p class="title">Проверить подключение</p></div>
    </div>
    <div class="list-tile" onclick="editCurrentSource()">
        <i>edit</i>
        <div class="content"><p class="title">Редактировать</p></div>
    </div>
    <div class="list-tile" onclick="deleteCurrentSource()" style="color: var(--error);">
        <i>delete</i>
        <div class="content"><p class="title">Удалить</p></div>
    </div>
    <nav class="right-align" style="margin-top: 16px;">
        <button class="border round" onclick="this.closest('dialog').close()">Закрыть</button>
    </nav>
</dialog>

<!-- Edit Source Dialog -->
<dialog id="edit-source-dialog" class="round" style="max-width: 360px; width: calc(100% - 32px);">
    <h5>Редактировать</h5>
    <form id="edit-source-form"
          hx-swap="none"
          hx-on::after-request="if(event.detail.successful) { this.closest('dialog').close(); location.reload(); }">
        <div class="field label border round">
            <input type="text" name="name" id="edit-source-name" required>
            <label>Название</label>
        </div>
        <label class="switch" style="margin: 16px 0;">
            <input type="checkbox" name="is_active" id="edit-source-active">
            <span>Активен</span>
        </label>
        <nav class="right-align" style="margin-top: 16px;">
            <button type="button" class="border round" onclick="this.closest('dialog').close()">Отмена</button>
            <button type="submit" class="round">Сохранить</button>
        </nav>
    </form>
</dialog>

<!-- Delete Confirmation Dialog -->
<dialog id="delete-source-dialog" class="round" style="max-width: 320px; width: calc(100% - 32px);">
    <h5>Удалить источник?</h5>
    <p class="secondary-text">Все собранные данные будут удалены.</p>
    <nav class="right-align" style="margin-top: 16px;">
        <button class="border round" onclick="this.closest('dialog').close()">Отмена</button>
        <button id="confirm-delete-source-btn" class="round error"
                hx-swap="none"
                hx-on::after-request="if(event.detail.successful) { this.closest('dialog').close(); location.reload(); }">
            Удалить
        </button>
    </nav>
</dialog>
{% endif %}
{% endblock %}

{% block extra_styles %}
<style>
.help-box {
    background: var(--surface-container-high);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 16px;
    font-size: 13px;
}
.help-box p {
    margin: 0 0 8px 0;
}
.help-box ol {
    margin: 0;
    padding-left: 20px;
}
.help-box li {
    margin-bottom: 4px;
}
.help-box a {
    color: var(--primary);
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
const credentialsTemplates = {
    jira: `
        <div class="help-box">
            <p><strong>Как получить API Token:</strong></p>
            <ol>
                <li>Войдите в <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank">Atlassian Account</a></li>
                <li>Нажмите "Create API token"</li>
                <li>Скопируйте токен</li>
            </ol>
        </div>
        <div class="field label border round">
            <input type="url" name="credentials.server_url" required placeholder=" ">
            <label>URL сервера (https://xxx.atlassian.net)</label>
        </div>
        <div class="field label border round">
            <input type="email" name="credentials.email" required placeholder=" ">
            <label>Email</label>
        </div>
        <div class="field label border round">
            <input type="password" name="credentials.api_token" required placeholder=" ">
            <label>API Token</label>
        </div>
    `,
    slack: `
        <div class="help-box">
            <p><strong>Как получить Bot Token:</strong></p>
            <ol>
                <li>Создайте приложение на <a href="https://api.slack.com/apps" target="_blank">api.slack.com</a></li>
                <li>Добавьте Bot Token Scopes: channels:history, channels:read</li>
                <li>Установите приложение в workspace</li>
                <li>Скопируйте Bot User OAuth Token (xoxb-...)</li>
            </ol>
        </div>
        <div class="field label border round">
            <input type="password" name="credentials.bot_token" required placeholder=" ">
            <label>Bot Token (xoxb-...)</label>
        </div>
        <div class="field label border round">
            <input type="text" name="config.channels" placeholder=" ">
            <label>Каналы (через запятую)</label>
        </div>
    `,
    gmail: `
        <div class="help-box">
            <p><strong>Как настроить Google Service Account:</strong></p>
            <ol>
                <li>Создайте проект в <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                <li>Включите Gmail API</li>
                <li>Создайте Service Account и скачайте JSON ключ</li>
                <li>В Google Workspace Admin включите domain-wide delegation</li>
            </ol>
        </div>
        <p class="small" style="margin: 8px 0 4px; color: var(--on-surface-variant);">Service Account JSON</p>
        <div class="field border round" style="margin-bottom: 12px;">
            <textarea name="credentials.credentials_json" required rows="3" placeholder="Вставьте содержимое JSON файла..." style="width: 100%; font-family: monospace; font-size: 12px;"></textarea>
        </div>
        <div class="field label border round">
            <input type="email" name="credentials.delegated_email" required placeholder=" ">
            <label>Email для делегирования</label>
        </div>
    `,
    google_calendar: `
        <div class="help-box">
            <p><strong>Как настроить Google Service Account:</strong></p>
            <ol>
                <li>Создайте проект в <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                <li>Включите Google Calendar API</li>
                <li>Создайте Service Account и скачайте JSON ключ</li>
                <li>В Google Workspace Admin включите domain-wide delegation</li>
            </ol>
        </div>
        <p class="small" style="margin: 8px 0 4px; color: var(--on-surface-variant);">Service Account JSON</p>
        <div class="field border round" style="margin-bottom: 12px;">
            <textarea name="credentials.credentials_json" required rows="3" placeholder="Вставьте содержимое JSON файла..." style="width: 100%; font-family: monospace; font-size: 12px;"></textarea>
        </div>
        <div class="field label border round">
            <input type="email" name="credentials.delegated_email" required placeholder=" ">
            <label>Email для делегирования</label>
        </div>
    `,
    outlook_mail: `
        <div class="help-box">
            <p><strong>Как получить токены Microsoft:</strong></p>
            <ol>
                <li>Зарегистрируйте приложение в <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank">Azure AD</a></li>
                <li>Добавьте разрешения: Mail.Read</li>
                <li>Получите токен через OAuth 2.0 flow</li>
            </ol>
        </div>
        <div class="field label border round">
            <input type="password" name="credentials.access_token" required placeholder=" ">
            <label>Access Token</label>
        </div>
        <div class="field label border round">
            <input type="password" name="credentials.refresh_token" placeholder=" ">
            <label>Refresh Token (опционально)</label>
        </div>
    `,
    outlook_calendar: `
        <div class="help-box">
            <p><strong>Как получить токены Microsoft:</strong></p>
            <ol>
                <li>Зарегистрируйте приложение в <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank">Azure AD</a></li>
                <li>Добавьте разрешения: Calendars.Read</li>
                <li>Получите токен через OAuth 2.0 flow</li>
            </ol>
        </div>
        <div class="field label border round">
            <input type="password" name="credentials.access_token" required placeholder=" ">
            <label>Access Token</label>
        </div>
        <div class="field label border round">
            <input type="password" name="credentials.refresh_token" placeholder=" ">
            <label>Refresh Token (опционально)</label>
        </div>
    `,
    teams: `
        <div class="help-box">
            <p><strong>Как получить токены Microsoft:</strong></p>
            <ol>
                <li>Зарегистрируйте приложение в <a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank">Azure AD</a></li>
                <li>Добавьте разрешения: ChannelMessage.Read.All</li>
                <li>Получите токен через OAuth 2.0 flow</li>
            </ol>
        </div>
        <div class="field label border round">
            <input type="password" name="credentials.access_token" required placeholder=" ">
            <label>Access Token</label>
        </div>
        <div class="field label border round">
            <input type="text" name="config.team_id" placeholder=" ">
            <label>Team ID (опционально)</label>
        </div>
    `
};

let currentSourceId = null;
let currentSourceName = null;
let currentSourceActive = false;

function showCredentialsFields(sourceType) {
    document.getElementById('credentials-fields').innerHTML = credentialsTemplates[sourceType] || '';
}

function filterByProject(projectId) {
    const url = new URL(window.location.href);
    if (projectId) {
        url.searchParams.set('project', projectId);
    } else {
        url.searchParams.delete('project');
    }
    window.location.href = url.toString();
}

function showSourceMenu(id, name, isActive) {
    currentSourceId = id;
    currentSourceName = name;
    currentSourceActive = isActive;
    document.getElementById('source-actions-title').textContent = name;
    document.getElementById('source-actions-dialog').showModal();
}

function testCurrentSource() {
    const dialog = document.getElementById('source-actions-dialog');
    const testTile = dialog.querySelector('.list-tile');
    const originalHtml = testTile.innerHTML;

    // Show loading state
    testTile.innerHTML = `
        <progress class="circle small"></progress>
        <div class="content"><p class="title">Проверяем...</p></div>
    `;
    testTile.style.pointerEvents = 'none';

    fetch(`/api/sources/${currentSourceId}/test`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            dialog.close();
            if (data.valid) {
                showToast('Подключение работает!', 'success');
            } else {
                showToast('Ошибка: ' + (data.error || 'Неизвестная ошибка'), 'error');
            }
        })
        .catch(() => {
            dialog.close();
            showToast('Не удалось проверить', 'error');
        })
        .finally(() => {
            testTile.innerHTML = originalHtml;
            testTile.style.pointerEvents = '';
        });
}

function editCurrentSource() {
    document.getElementById('source-actions-dialog').close();
    document.getElementById('edit-source-name').value = currentSourceName;
    document.getElementById('edit-source-active').checked = currentSourceActive;
    document.getElementById('edit-source-form').setAttribute('hx-put', `/api/sources/${currentSourceId}`);
    htmx.process(document.getElementById('edit-source-form'));
    document.getElementById('edit-source-dialog').showModal();
}

function deleteCurrentSource() {
    document.getElementById('source-actions-dialog').close();
    document.getElementById('confirm-delete-source-btn').setAttribute('hx-delete', `/api/sources/${currentSourceId}`);
    htmx.process(document.getElementById('confirm-delete-source-btn'));
    document.getElementById('delete-source-dialog').showModal();
}
</script>
{% endblock %}
