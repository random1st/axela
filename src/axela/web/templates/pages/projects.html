{% extends "base.html" %}

{% block header_title %}Проекты{% endblock %}

{% block content %}
{% if not projects %}
<div class="empty-state">
    <i>folder_off</i>
    <h5 style="margin-top: 16px;">Нет проектов</h5>
    <p class="secondary-text">Создайте первый проект для организации источников</p>
</div>
{% else %}
<div class="card">
    {% for project in projects %}
    <div class="list-tile" id="project-{{ project.id }}">
        <div class="leading" style="{% if project.color %}background: {{ project.color }};{% endif %}">
            <i style="{% if project.color %}color: white;{% endif %}">folder</i>
        </div>
        <div class="content">
            <p class="title">{{ project.name }}</p>
            <p class="subtitle">{{ project.created_at.strftime('%d.%m.%Y') }}</p>
        </div>
        <button class="circle transparent small" onclick="editProject('{{ project.id }}', '{{ project.name }}', '{{ project.color or '' }}')">
            <i>edit</i>
        </button>
    </div>
    {% if not loop.last %}<div class="divider" style="margin-left: 72px;"></div>{% endif %}
    {% endfor %}
</div>
{% endif %}

<!-- FAB -->
<button class="fab primary" onclick="document.getElementById('new-project-dialog').showModal()">
    <i>add</i>
</button>

<!-- New Project Dialog -->
<dialog id="new-project-dialog" class="round" style="max-width: 360px; width: calc(100% - 32px);">
    <h5>Новый проект</h5>
    <form hx-post="/api/projects"
          hx-swap="none"
          hx-on::after-request="handleProjectResponse(event, this, 'new-project-error')">
        <div class="field label border round">
            <input type="text" name="name" required minlength="1" maxlength="100">
            <label>Название</label>
        </div>
        <p id="new-project-error" class="error-text" style="display: none; color: var(--error); font-size: 13px; margin: 4px 0;"></p>
        <input type="hidden" name="color" id="new-project-color" value="#6750A4">
        <p class="small" style="margin: 8px 0 4px;">Цвет</p>
        <div class="color-picker-grid">
            <button type="button" class="color-swatch selected" data-color="#6750A4" style="background: #6750A4;" onclick="selectColor(this, 'new-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#D81B60" style="background: #D81B60;" onclick="selectColor(this, 'new-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#F4511E" style="background: #F4511E;" onclick="selectColor(this, 'new-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#FB8C00" style="background: #FB8C00;" onclick="selectColor(this, 'new-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#43A047" style="background: #43A047;" onclick="selectColor(this, 'new-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#00ACC1" style="background: #00ACC1;" onclick="selectColor(this, 'new-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#3949AB" style="background: #3949AB;" onclick="selectColor(this, 'new-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#8E24AA" style="background: #8E24AA;" onclick="selectColor(this, 'new-project-color')"></button>
        </div>
        <nav class="right-align" style="margin-top: 16px;">
            <button type="button" class="border round" onclick="this.closest('dialog').close()">Отмена</button>
            <button type="submit" class="round">Создать</button>
        </nav>
    </form>
</dialog>

<!-- Edit Project Dialog -->
<dialog id="edit-project-dialog" class="round" style="max-width: 360px; width: calc(100% - 32px);">
    <h5>Редактировать</h5>
    <form id="edit-project-form"
          hx-swap="none"
          hx-on::after-request="handleProjectResponse(event, this, 'edit-project-error')">
        <div class="field label border round">
            <input type="text" name="name" id="edit-project-name" required>
            <label>Название</label>
        </div>
        <p id="edit-project-error" class="error-text" style="display: none; color: var(--error); font-size: 13px; margin: 4px 0;"></p>
        <input type="hidden" name="color" id="edit-project-color" value="#6750A4">
        <p class="small" style="margin: 8px 0 4px;">Цвет</p>
        <div class="color-picker-grid" id="edit-color-grid">
            <button type="button" class="color-swatch" data-color="#6750A4" style="background: #6750A4;" onclick="selectColor(this, 'edit-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#D81B60" style="background: #D81B60;" onclick="selectColor(this, 'edit-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#F4511E" style="background: #F4511E;" onclick="selectColor(this, 'edit-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#FB8C00" style="background: #FB8C00;" onclick="selectColor(this, 'edit-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#43A047" style="background: #43A047;" onclick="selectColor(this, 'edit-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#00ACC1" style="background: #00ACC1;" onclick="selectColor(this, 'edit-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#3949AB" style="background: #3949AB;" onclick="selectColor(this, 'edit-project-color')"></button>
            <button type="button" class="color-swatch" data-color="#8E24AA" style="background: #8E24AA;" onclick="selectColor(this, 'edit-project-color')"></button>
        </div>
        <nav class="right-align" style="margin-top: 16px;">
            <button type="button" class="border round" onclick="this.closest('dialog').close()">Отмена</button>
            <button type="submit" class="round">Сохранить</button>
        </nav>
    </form>
</dialog>
{% endblock %}

{% block extra_styles %}
<style>
.color-picker-grid {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.color-swatch {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    padding: 0;
    transition: transform 0.1s;
}
.color-swatch:hover {
    transform: scale(1.1);
}
.color-swatch.selected {
    border-color: white;
    box-shadow: 0 0 0 2px var(--primary);
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
function selectColor(btn, inputId) {
    const grid = btn.closest('.color-picker-grid');
    grid.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById(inputId).value = btn.dataset.color;
}

function handleProjectResponse(event, form, errorId) {
    const errorEl = document.getElementById(errorId);
    if (event.detail.successful) {
        errorEl.style.display = 'none';
        form.reset();
        form.closest('dialog').close();
        location.reload();
    } else {
        const response = event.detail.xhr.responseText;
        errorEl.textContent = response || 'Ошибка при сохранении';
        errorEl.style.display = 'block';
    }
}

function editProject(id, name, color) {
    document.getElementById('edit-project-name').value = name;
    document.getElementById('edit-project-error').style.display = 'none';
    const colorValue = color || '#6750A4';
    document.getElementById('edit-project-color').value = colorValue;

    // Select the matching color swatch
    const grid = document.getElementById('edit-color-grid');
    grid.querySelectorAll('.color-swatch').forEach(s => {
        s.classList.toggle('selected', s.dataset.color === colorValue.toUpperCase());
    });

    document.getElementById('edit-project-form').setAttribute('hx-put', `/api/projects/${id}`);
    htmx.process(document.getElementById('edit-project-form'));
    document.getElementById('edit-project-dialog').showModal();
}

if (new URLSearchParams(window.location.search).get('action') === 'new') {
    document.getElementById('new-project-dialog').showModal();
}
</script>
{% endblock %}
