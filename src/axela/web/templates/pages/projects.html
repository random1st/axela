{% extends "base.html" %}

{% block header_title %}Проекты{% endblock %}

{% block content %}
{% if not projects %}
<div class="empty-state">
    <i>folder_off</i>
    <h5 style="margin-top: 16px;">Нет проектов</h5>
    <p class="secondary-text">Создайте первый проект для организации источников</p>
</div>
{% else %}
<div class="card">
    {% for project in projects %}
    <div class="list-tile" id="project-{{ project.id }}">
        <div class="leading" style="{% if project.color %}background: {{ project.color }};{% endif %}">
            <i style="{% if project.color %}color: white;{% endif %}">folder</i>
        </div>
        <div class="content">
            <p class="title">{{ project.name }}</p>
            <p class="subtitle">{{ project.created_at.strftime('%d.%m.%Y') }}</p>
        </div>
        <button class="circle transparent small" onclick="editProject('{{ project.id }}', '{{ project.name }}', '{{ project.color or '' }}')">
            <i>edit</i>
        </button>
    </div>
    {% if not loop.last %}<div class="divider" style="margin-left: 72px;"></div>{% endif %}
    {% endfor %}
</div>
{% endif %}

<!-- FAB -->
<button class="fab primary" onclick="document.getElementById('new-project-dialog').showModal()">
    <i>add</i>
</button>

<!-- New Project Dialog -->
<dialog id="new-project-dialog" class="round" style="max-width: 360px; width: calc(100% - 32px);">
    <h5>Новый проект</h5>
    <form hx-post="/web/api/projects"
          hx-swap="none"
          hx-on::after-request="if(event.detail.successful) { this.reset(); this.closest('dialog').close(); location.reload(); }">
        <div class="field label border round">
            <input type="text" name="name" required minlength="1" maxlength="100">
            <label>Название</label>
        </div>
        <div class="field label border round">
            <input type="color" name="color" value="#6750A4" style="height: 48px;">
            <label>Цвет</label>
        </div>
        <nav class="right-align" style="margin-top: 16px;">
            <button type="button" class="border round" onclick="this.closest('dialog').close()">Отмена</button>
            <button type="submit" class="round">Создать</button>
        </nav>
    </form>
</dialog>

<!-- Edit Project Dialog -->
<dialog id="edit-project-dialog" class="round" style="max-width: 360px; width: calc(100% - 32px);">
    <h5>Редактировать</h5>
    <form id="edit-project-form"
          hx-swap="none"
          hx-on::after-request="if(event.detail.successful) { this.closest('dialog').close(); location.reload(); }">
        <div class="field label border round">
            <input type="text" name="name" id="edit-project-name" required>
            <label>Название</label>
        </div>
        <div class="field label border round">
            <input type="color" name="color" id="edit-project-color" style="height: 48px;">
            <label>Цвет</label>
        </div>
        <nav class="right-align" style="margin-top: 16px;">
            <button type="button" class="border round" onclick="this.closest('dialog').close()">Отмена</button>
            <button type="submit" class="round">Сохранить</button>
        </nav>
    </form>
</dialog>
{% endblock %}

{% block extra_scripts %}
<script>
function editProject(id, name, color) {
    document.getElementById('edit-project-name').value = name;
    document.getElementById('edit-project-color').value = color || '#6750A4';
    document.getElementById('edit-project-form').setAttribute('hx-put', `/web/api/projects/${id}`);
    htmx.process(document.getElementById('edit-project-form'));
    document.getElementById('edit-project-dialog').showModal();
}

if (new URLSearchParams(window.location.search).get('action') === 'new') {
    document.getElementById('new-project-dialog').showModal();
}
</script>
{% endblock %}
